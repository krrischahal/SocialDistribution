{% extends 'base.html' %}
{% block content %}
{% load static %}
<link
  rel="stylesheet"
  type="text/css"
  href="{% static 'socialnetwork/css/create-post.css' %}"
/>
<nav class="form-page-container">
    <nav class="form-container">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input class="text-input" type="text" name="title" id="title-field" placeholder="Title" maxlength="255" required value="{{ serializer.data.title }}"><br>
            <input class="text-input" type="text" name="description" id="description-field" placeholder="Description" value="{{ serializer.data.description }}"><br>
            <textarea class="text-input" name="content" id="text-content-field" placeholder="Write your post...">{{ serializer.data.content }}</textarea><br>

            <!-- Hidden content field for image base64 data -->
            <input type="hidden" name="image_content" id="image-content-field">

            <!-- Image upload field -->
            <input type="file" name="image" id="image-upload-field"><br />

            <!-- Display existing image if there is one -->
            {% if serializer.instance.image %}
                <img src="{{ serializer.instance.image.url }}" alt="Current Image" style="max-width: 200px;">
            {% endif %}

            <div class="select-input-container">
                <select class="select-input" name="content_type" id="content-type-select">
                    <option value="" disabled>--Content type--</option>
                    <option value="text/plain" {% if serializer.data.content_type == 'text/plain' %}selected{% endif %}>Plaintext</option>
                    <option value="text/markdown" {% if serializer.data.content_type == 'text/markdown' %}selected{% endif %}>CommonMark</option>
                    <option value="application/base64" {% if serializer.data.content_type == 'application/base64' %}selected{% endif %}>Image</option>
                    <option value="image/png;base64" {% if serializer.data.content_type == 'image/png;base64' %}selected{% endif %}>Image (PNG)</option>
                    <option value="image/jpeg;base64" {% if serializer.data.content_type == 'image/jpeg;base64' %}selected{% endif %}>Image (JPEG)</option>
                </select>
                <select class="select-input" name="visibility" id="visibility-select">
                    <option value="" disabled>--Visibility--</option>
                    <option value="PUBLIC" {% if serializer.data.visibility == 'PUBLIC' %}selected{% endif %}>Public</option>
                    <option value="UNLISTED" {% if serializer.data.visibility == 'UNLISTED' %}selected{% endif %}>Unlisted</option>
                    <option value="FRIENDS" {% if serializer.data.visibility == 'FRIENDS' %}selected{% endif %}>Friends only</option>
                </select><br>
            </div>
            <input class="submit-button" type="submit" value="Update post">
        </form>
    </nav>
</nav>

<script>
    document.getElementById('content-type-select').addEventListener('change', function() {
        var selected = this.value;
        var textField = document.getElementById('text-content-field');
        var imageField = document.getElementById('image-upload-field');
        var imageContentField = document.getElementById('image-content-field');

        if (selected === 'application/base64' || selected.startsWith('image/')) {
            textField.style.display = 'none';
            textField.required = false;
            textField.value = ''; // Clear text content
            imageField.style.display = 'block';
            imageField.required = true;
        } else {
            textField.style.display = 'block';
            textField.required = true;
            imageField.style.display = 'none';
            imageField.required = false;
            imageField.value = ''; // Clear image field
            imageContentField.value = ''; // Clear image content
        }
    });

    // Listen for image selection and encode it to base64
    document.getElementById('image-upload-field').addEventListener('change', function() {
        var file = this.files[0];
        var imageContentField = document.getElementById('image-content-field');

        if (file) {
            var reader = new FileReader();
            reader.onload = function(event) {
                // Base64 encode the image
                // var base64Data = event.target.result.split(',')[1];
                // imageContentField.value = base64Data;
                imageContentField.value = event.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            imageContentField.value = '';
        }
    });

    // Trigger the change event on page load to set the correct fields
    document.getElementById('content-type-select').dispatchEvent(new Event('change'));
</script>

{% endblock %}
